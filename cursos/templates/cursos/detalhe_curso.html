{% extends 'cursos/base.html' %}
{% load static %}

{% block conteudo %}
<div class="main-container">
    <h1 style="color: {{ curso.cor_neon }}; text-shadow: 0 0 10px {{ curso.cor_neon }}55;">{{ curso.nome }}</h1>
    <p style="color: #888; margin-bottom: 30px;">Conteúdo e materiais de apoio</p>

    <div style="display: grid; gap: 30px;">
        {% for modulo in curso.modulos.all %}
            <div class="modulo-section">
                <h2 style="color: #fff; border-left: 4px solid {{ curso.cor_neon }}; padding-left: 15px; margin-bottom: 20px;">
                    {{ modulo.titulo }}
                </h2>

                <div style="display: grid; gap: 20px;">
                    {% for material in modulo.materiais.all %}
                        <div class="glass-card" style="padding: 20px; border: 1px solid rgba(255,255,255,0.1);">
                            
                            {# --- CABEÇALHO DO CARD COM BOTÕES DE AÇÃO --- #}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    {% if material.tipo_arquivo == 'link' %}
                                        <i class="fab fa-youtube" style="font-size: 1.8rem; color: #ff0000;"></i>
                                    {% elif material.tipo_arquivo == 'video' %}
                                        <i class="fas fa-play-circle" style="font-size: 1.8rem; color: {{ curso.cor_neon }};"></i>
                                    {% elif material.tipo_arquivo == 'pdf' %}
                                        <i class="fas fa-file-pdf" style="font-size: 1.8rem; color: #ff4757;"></i>
                                    {% else %}
                                        <i class="fas fa-image" style="font-size: 1.8rem; color: #00d2d3;"></i>
                                    {% endif %}
                                    <h3 style="margin: 0; font-size: 1.1rem; color: #eee;">{{ material.titulo }}</h3>
                                </div>

                                <div style="display: flex; gap: 10px;">
                                    {% if material.arquivo %}
                                        {# Usamos url_corrigida para garantir o download do arquivo real #}
                                        <a href="{{ material.url_corrigida }}" download class="btn-entrar" 
                                           style="text-decoration: none; font-size: 0.75rem; padding: 7px 12px; background: rgba(255,255,255,0.1); border: 1px solid {{ curso.cor_neon }}; color: #fff;">
                                            <i class="fas fa-download"></i> BAIXAR
                                        </a>
                                    {% endif %}
                                    
                                    {% if material.tipo_arquivo == 'pdf' or material.link_externo %}
                                        {# Botão ABRIR redireciona para o link externo ou para a URL corrigida do PDF #}
                                        <a href="{% if material.link_externo %}{{ material.link_externo }}{% else %}{{ material.url_corrigida }}{% endif %}" 
                                           target="_blank" class="btn-entrar" 
                                           style="text-decoration: none; font-size: 0.75rem; padding: 7px 12px; background: {{ curso.cor_neon }}; border: none; color: #000; font-weight: bold;">
                                            <i class="fas fa-external-link-alt"></i> ABRIR EM NOVA ABA
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            {# --- ÁREA DE VISUALIZAÇÃO INTERNA --- #}
                            <div class="visualizacao-container" style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                                
                                {# 1. LINK EXTERNO (YOUTUBE / DRIVE) #}
                                {% if material.tipo_arquivo == 'link' %}
                                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                                        <iframe src="{{ material.embed_url }}" 
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" 
                                                allowfullscreen></iframe>
                                    </div>

                                {# 2. VÍDEO #}
                                {% elif material.tipo_arquivo == 'video' %}
                                    <video controls controlsList="nodownload" style="width: 100%; display: block;">
                                        <source src="{{ material.url_corrigida }}" type="video/mp4">
                                        Seu navegador não suporta vídeos.
                                    </video>

                                {# 3. IMAGEM #}
                                {% elif material.tipo_arquivo == 'imagem' %}
                                    <div style="text-align: center; padding: 10px;">
                                        <img src="{{ material.url_corrigida }}" style="max-width: 100%; max-height: 500px; border-radius: 4px;">
                                    </div>

                                {# 4. PDF (USANDO PLAYER DO GOOGLE PARA EVITAR ERRO DE IMAGEM DO CLOUDINARY) #}
                                {% elif material.tipo_arquivo == 'pdf' %}
                                    <div style="height: 600px; width: 100%;">
                                        <iframe src="https://docs.google.com/gview?url={{ material.url_corrigida }}&embedded=true" 
                                                style="width:100%; height:100%;" frameborder="0"></iframe>
                                    </div>

                                {# 5. OUTROS / FALLBACK #}
                                {% else %}
                                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.02);">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #888; margin-bottom: 15px;"></i>
                                        <p style="color: #ddd;">Visualização indisponível para este formato.</p>
                                        <a href="{{ material.url_corrigida }}" target="_blank" style="color: {{ curso.cor_neon }}; text-decoration: underline;">
                                            Clique para baixar ou abrir o arquivo
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <p style="color: #555; font-style: italic; margin-left: 20px;">Nenhum material neste módulo.</p>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}